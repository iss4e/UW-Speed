[{"id":"66eb2783.9914d8","type":"tab","label":"SPEED Flow"},{"id":"2dea5fe7.5ae3f8","type":"tab","label":"Etc"},{"id":"f915f1f4.06ea1","type":"MySQLdatabase","z":"66eb2783.9914d8","host":"127.0.0.1","port":"3306","db":"NodeRedDB","tz":""},{"id":"832b6d06.29603","type":"http in","z":"66eb2783.9914d8","name":"","url":"/user","method":"post","swaggerDoc":"","x":90,"y":260,"wires":[["eca9b697.c0908"]]},{"id":"fb521e11.03c948","type":"http response","z":"66eb2783.9914d8","name":"","x":970,"y":180,"wires":[]},{"id":"c205a536.c29","type":"mysql","z":"66eb2783.9914d8","mydb":"f915f1f4.06ea1","name":"","x":440,"y":260,"wires":[["78134292.a272bc"]]},{"id":"f07e4707.87988","type":"http response","z":"2dea5fe7.5ae3f8","name":"","x":526.5,"y":210,"wires":[]},{"id":"b21dadb4.2d1388","type":"http in","z":"2dea5fe7.5ae3f8","name":"","url":"/eject-usb","method":"post","swaggerDoc":"","x":132,"y":223.5,"wires":[["368b5693.2b5902","f22b93e1.783e1"]]},{"id":"3da9e340.b6943c","type":"template","z":"2dea5fe7.5ae3f8","name":"","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<html>\n<head>\n<title>Eject USB</title>\n</head>\n<body>\n{{payload}}\n</body>\n</html>","x":468.5,"y":140.5,"wires":[["f07e4707.87988"]]},{"id":"368b5693.2b5902","type":"function","z":"2dea5fe7.5ae3f8","name":"","func":"msg.payload=\"eject_usb\";\nreturn msg;","outputs":1,"noerr":0,"x":179,"y":156,"wires":[["5ac933c8.ae327c"]]},{"id":"5ac933c8.ae327c","type":"tcp request","z":"2dea5fe7.5ae3f8","server":"localhost","port":"2000","out":"time","splitc":"1000","name":"","x":325,"y":80,"wires":[["3da9e340.b6943c"]]},{"id":"ed6e258f.75517","type":"template","z":"2dea5fe7.5ae3f8","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Number of transactions: {{payload.length}}!","x":429.5,"y":603,"wires":[["73459434.fdccec"]]},{"id":"73459434.fdccec","type":"http response","z":"2dea5fe7.5ae3f8","name":"","x":544.5,"y":652.5,"wires":[]},{"id":"5d881c94.17417c","type":"http in","z":"2dea5fe7.5ae3f8","name":"","url":"/test","method":"get","swaggerDoc":"","x":82,"y":663,"wires":[["7be69664.5a4308"]]},{"id":"94977b0f.d979c","type":"mysql","z":"2dea5fe7.5ae3f8","mydb":"f915f1f4.06ea1","name":"","x":353,"y":658.5,"wires":[["ed6e258f.75517"]]},{"id":"7be69664.5a4308","type":"function","z":"2dea5fe7.5ae3f8","name":"SelectTransactions","func":"msg.topic=\"SELECT * FROM customers WHERE id=1;\";\nreturn msg;","outputs":1,"noerr":0,"x":203.5,"y":615,"wires":[["94977b0f.d979c"]]},{"id":"f22b93e1.783e1","type":"debug","z":"2dea5fe7.5ae3f8","name":"","active":true,"console":"false","complete":"req.query","x":311,"y":273,"wires":[]},{"id":"78134292.a272bc","type":"function","z":"66eb2783.9914d8","name":"CheckUser","func":"//node.warn(msg.id);\nif(msg.payload.length){     //User already exists\n    msg.payload=msg.payload[0];\n    return [msg,null];\n}else{                      //Add user\n    msg.topic=\"INSERT INTO customers (id,money,datescanned,scaninfo) VALUES(\"+\n        msg.id+\",0,NOW(),'money');\";\n    return [null,msg];\n}\n","outputs":"2","noerr":0,"x":630,"y":260,"wires":[["b9ecbdae.31f9e"],["ac555a45.e3f8b"]]},{"id":"d858251f.30a02","type":"http in","z":"66eb2783.9914d8","name":"","url":"/process-payment","method":"post","swaggerDoc":"","x":140,"y":120,"wires":[["7f15b96d.5ba9c8"]]},{"id":"7f15b96d.5ba9c8","type":"function","z":"66eb2783.9914d8","name":"AddMoney","func":"msg.id=msg.payload.id;\nmsg.money=parseInt(msg.payload.balance)+parseInt(msg.payload.money);\n\nmsg.topic=\"INSERT INTO customers (id,money,datescanned,scaninfo) VALUES(\"+\n    msg.id+\",\"+msg.money+\",NOW(),'money');\";\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":120,"wires":[["92a0478c.1906c"]]},{"id":"16c1812e.6712ff","type":"template","z":"66eb2783.9914d8","name":"MoneyAdded","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html>\n<head>\n<title>Process new user payment</title>\n</head>\n<body>\nNew balance of user ID {{id}}:<br>\n<img src='/speed/money.png' alt='money' width = '48' height='48' style='right;'>\n{{money}} units.\n\n<br><form action=\"main\" method=\"get\"><button type=\"submit\">Home</button></form>\n\n</body>\n</html>\n","x":800,"y":120,"wires":[["fb521e11.03c948"]]},{"id":"92a0478c.1906c","type":"mysql","z":"66eb2783.9914d8","mydb":"f915f1f4.06ea1","name":"","x":540,"y":120,"wires":[["16c1812e.6712ff"]]},{"id":"3c22b13e.290386","type":"function","z":"66eb2783.9914d8","name":"RequestLatest","func":"msg.topic=\"SELECT * FROM customers WHERE scaninfo='money' AND id='\"+msg.id+\n    \"' ORDER BY datescanned DESC LIMIT 1;\"\nreturn msg;","outputs":"1","noerr":0,"x":400,"y":320,"wires":[["c205a536.c29"]]},{"id":"d363afd7.552098","type":"inject","z":"2dea5fe7.5ae3f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":202.88333129882812,"y":514.88330078125,"wires":[["e7e9e818.4b1228"]]},{"id":"c851f679.78a788","type":"mysql","z":"2dea5fe7.5ae3f8","mydb":"f915f1f4.06ea1","name":"","x":567.3833312988281,"y":433.88330078125,"wires":[[]]},{"id":"e7e9e818.4b1228","type":"function","z":"2dea5fe7.5ae3f8","name":"AddMoney","func":"var uID=1;\nvar accountMoney=1;\nvar dateTime=new Date().toISOString().slice(0, 19).replace('T', ' ');\n//node.warn(dateTime);\n\nmsg.topic=\"INSERT INTO customers (id,money,datescanned,scaninfo) VALUES(\"+\n    uID+\",\"+accountMoney+\",'\"+dateTime+\"','\"+accountMoney+\" units added');\";\n\nreturn msg;","outputs":1,"noerr":0,"x":365.8833312988281,"y":482.88330078125,"wires":[["c851f679.78a788"]]},{"id":"de4228f1.5262e8","type":"inject","z":"2dea5fe7.5ae3f8","name":"PURGE","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":190.88333129882812,"y":402.38330078125,"wires":[["ebe4bfa7.3547"]]},{"id":"ebe4bfa7.3547","type":"function","z":"2dea5fe7.5ae3f8","name":"ClearHistory","func":"msg.topic=\"DELETE FROM customers WHERE id<100;\"\nreturn msg;","outputs":1,"noerr":0,"x":370.8833312988281,"y":407.38330078125,"wires":[["c851f679.78a788"]]},{"id":"457bc2ca.ef10dc","type":"http in","z":"66eb2783.9914d8","name":"","url":"/main","method":"get","swaggerDoc":"","x":90,"y":80,"wires":[["e5f9f711.ab8ee"]]},{"id":"e5f9f711.ab8ee","type":"template","z":"66eb2783.9914d8","name":"Main","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<html>\n<head>\n<title>Main</title>\n</head>\n<body>\n\nClick and then touch the card:<br>\n<form method='post' action='user'>\n<input type='image' src='/speed/rfid.png' alt='rfid' width=\"100\" height=\"100\">\n</form>\n\n</body>\n</html>\n","x":830,"y":80,"wires":[["fb521e11.03c948"]]},{"id":"b9ecbdae.31f9e","type":"template","z":"66eb2783.9914d8","name":"UserInfo","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n<title>\nFound user\n</title>\n</head>\n<body>\n\nCurrent balance for user ID {{id}}:<br>\n<img src='/speed/money.png' alt='money' width = '48' height='48' style='right;'>\n{{payload.money}} units.\n\n<br>\n<form method ='post' action='process-payment'>\n+<input type='text' name='money'> units.\n<input type='hidden' name='id' value='{{id}}'>\n<input type='hidden' name='balance' value='{{payload.money}}'>\n<input type='submit' name='payment' value='Enter'>\n</form>\n\n<br>\n<form method='post' action='account-history'>\n<input type='hidden' name='id' value='{{id}}'>\n<input type='image' src='/speed/history.png' width=\"48\" height=\"48\">\n</form>\n\n<br><form action=\"main\" method=\"get\"><button type=\"submit\">Home</button></form>\n</body>\n</html>\n","x":820,"y":260,"wires":[["fb521e11.03c948"]]},{"id":"78b0e255.6b20e4","type":"http in","z":"66eb2783.9914d8","name":"","url":"/account-history","method":"post","swaggerDoc":"","x":130,"y":200,"wires":[["e435c637.0508b8"]]},{"id":"c3a10f60.0369b8","type":"template","z":"66eb2783.9914d8","name":"AccountHistory","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n<title>\nAccount history\n</title>\n</head>\n<body>\n<div id='history'>\nRecent account history for user ID {{id}}:<br>\n{{{payload}}}\n</div>\n<br><form action=\"main\" method=\"get\"><button type=\"submit\">Home</button></form>\n</body>\n</html>","x":790,"y":200,"wires":[["fb521e11.03c948"]]},{"id":"37634ebb.68cf22","type":"mysql","z":"66eb2783.9914d8","mydb":"f915f1f4.06ea1","name":"","x":480,"y":200,"wires":[["8a86734a.0cac9"]]},{"id":"e435c637.0508b8","type":"function","z":"66eb2783.9914d8","name":"","func":"msg.id=msg.payload.id;\nmsg.topic=\"SELECT * FROM customers WHERE id=\"+msg.id+\n    \" ORDER BY datescanned DESC LIMIT 10;\";\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":200,"wires":[["37634ebb.68cf22"]]},{"id":"8a86734a.0cac9","type":"function","z":"66eb2783.9914d8","name":"","func":"var l=\"<table style='width:90%;'><tr><th>Date</th><th>Info</th><th>Money</th></tr>\";\nfor(var i=0;i<msg.payload.length;i++){\n    var el=msg.payload[i];\n    l+=\"<tr><td>\"+el.datescanned+\"</td><td>\"+\n        el.scaninfo+\"</td><td style='text-align:right;'>\"+\n        el.money+\"</td></tr>\";\n}\nl+=\"</table>\";\nmsg.payload=l;\nreturn msg;\n","outputs":1,"noerr":0,"x":630,"y":200,"wires":[["c3a10f60.0369b8"]]},{"id":"3bbdda89.1f72c6","type":"inject","z":"66eb2783.9914d8","name":"START UP","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":80,"y":640,"wires":[["5f144bf8.1cf0bc"]]},{"id":"2392d2a4.9eefc6","type":"debug","z":"66eb2783.9914d8","name":"stderr","active":true,"console":"false","complete":"payload","x":410,"y":680,"wires":[]},{"id":"c5ee4a02.6caad","type":"debug","z":"66eb2783.9914d8","name":"return code","active":true,"console":"false","complete":"payload","x":390,"y":720,"wires":[]},{"id":"d3ac1f92.18ad6","type":"delay","z":"66eb2783.9914d8","name":"Restart card reader","pauseType":"delay","timeout":"0.5","timeoutUnits":"seconds","rate":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":220,"y":780,"wires":[["5f144bf8.1cf0bc"]]},{"id":"e4bf1e18.70ab28","type":"function","z":"66eb2783.9914d8","name":"ReadRFID","func":"var id=parseInt(msg.payload,16);\n//var id=Math.floor(Math.random()*100);\n//var id=42;\nmsg.id=id;\nnode.warn(msg.id);\n\nvar http=flow.get(\"httpRequest\");\n\nif(!http){\n    node.warn(\"id used for charging\");\n    msg.topic=\"SELECT * FROM customers WHERE scaninfo='money' AND id='\"+msg.id+\n    \"' ORDER BY datescanned DESC LIMIT 1;\";\n    return [null,msg];\n}\n\nnode.warn(\"id used for query\");\nmsg=http;\nflow.set(\"httpRequest\",null);\nmsg.id=id;\n\nreturn [msg,null];","outputs":"2","noerr":0,"x":170,"y":480,"wires":[["3c22b13e.290386","ed582165.304748"],["47eb8d59.effc24"]]},{"id":"ac555a45.e3f8b","type":"mysql","z":"66eb2783.9914d8","mydb":"f915f1f4.06ea1","name":"","x":580,"y":400,"wires":[["3c22b13e.290386"]]},{"id":"eca9b697.c0908","type":"function","z":"66eb2783.9914d8","name":"StoreHTTP","func":"flow.set(\"httpRequest\",msg);\nnode.warn(\"id requested\");","outputs":"0","noerr":0,"x":150,"y":340,"wires":[]},{"id":"6dd67408.5eb824","type":"rpi-gpio out","z":"66eb2783.9914d8","name":"LED","pin":"15","set":false,"level":"0","out":"pwm","x":990,"y":480,"wires":[]},{"id":"8968a1ce.7498c8","type":"rpi-gpio out","z":"66eb2783.9914d8","name":"BUZZER","pin":"12","set":false,"level":"0","out":"pwm","x":980,"y":420,"wires":[]},{"id":"5f144bf8.1cf0bc","type":"exec","z":"66eb2783.9914d8","command":"python","addpay":false,"append":"/home/pi/.node-red/user_modules/MFRC522-python/Read.py","useSpawn":true,"timer":"","name":"","x":240,"y":660,"wires":[["e4bf1e18.70ab28"],[],["c5ee4a02.6caad","d3ac1f92.18ad6"]]},{"id":"3ac7f695.401852","type":"exec","z":"2dea5fe7.5ae3f8","command":"sudo","addpay":false,"append":"node /home/pi/.node-red/node_modules/rc522/rc522_output.js","useSpawn":true,"timer":"","name":"","x":296.8833312988281,"y":809.88330078125,"wires":[[],[],[]]},{"id":"94045909.a803c","type":"function","z":"66eb2783.9914d8","name":"CheckBalance","func":"if(msg.payload.length){\n    var money=msg.payload[0].money;\n    if(money>0){\n        msg.topic=\"INSERT INTO customers (id,money,datescanned,scaninfo) VALUES(\"+\n            msg.id+\",\"+(money-1)+\",NOW(),'money');\";\n        node.warn(\"charging money\");\n        return [msg,null];\n    }\n}\n\nnode.warn(\"not enough money\");\nreturn [null,msg];\n","outputs":"2","noerr":0,"x":580,"y":600,"wires":[["2278f747.52b738","ed582165.304748"],["2d98a64c.957c22"]]},{"id":"47eb8d59.effc24","type":"mysql","z":"66eb2783.9914d8","mydb":"f915f1f4.06ea1","name":"","x":340,"y":540,"wires":[["94045909.a803c"]]},{"id":"2278f747.52b738","type":"mysql","z":"66eb2783.9914d8","mydb":"f915f1f4.06ea1","name":"","x":540,"y":500,"wires":[[]]},{"id":"ed582165.304748","type":"function","z":"66eb2783.9914d8","name":"ActuatePos","func":"msg.payload=100;\nnode.send(msg);\nmsg.payload=0;\nsetTimeout(function(){node.send(msg);},500);","outputs":1,"noerr":0,"x":770,"y":420,"wires":[["8968a1ce.7498c8","6dd67408.5eb824"]]},{"id":"2d98a64c.957c22","type":"function","z":"66eb2783.9914d8","name":"ActuateNeg","func":"for(var i=0;i<4;i++){\n    var t=i*2*100;\n    setTimeout(function(){node.send({payload:100});},t);\n    setTimeout(function(){node.send({payload:0});},t+100);\n}","outputs":1,"noerr":0,"x":760,"y":460,"wires":[["8968a1ce.7498c8","6dd67408.5eb824"]]}]